//internal\ui\modals\create_item\file_upload.go
package create_item

import (
	"fmt"
	"image/color"
	"os/exec"
	"strings"

	"fyne.io/fyne/v2"
	"fyne.io/fyne/v2/canvas"
	"fyne.io/fyne/v2/container"
	"fyne.io/fyne/v2/widget"
)

// FileUploadType –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
type FileUploadType int

const (
	ImageUpload FileUploadType = iota
	FileUpload
)

// FileUploadConfig —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
type FileUploadConfig struct {
	Label           string
	Filter          []string
	BackgroundColor color.Color
	MinSize         fyne.Size
	UploadType      FileUploadType
}

// FileUploadState —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
type FileUploadState struct {
	SelectedFiles *[]string
	UpdateDisplay func()
}

// openWindowsFileDialog –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ Windows
func openWindowsFileDialog(filter []string, multiSelect bool) ([]string, error) {
	// –°–æ–∑–¥–∞–µ–º PowerShell —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
	psScript := `
Add-Type -AssemblyName System.Windows.Forms
$dialog = New-Object System.Windows.Forms.OpenFileDialog
$dialog.Title = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã"
$dialog.Multiselect = $true
`

	// –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω
	if len(filter) > 0 {
		// –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Ñ–∏–ª—å—Ç—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "Image files (*.jpg, *.png)|*.jpg;*.png"
		filterExtensions := []string{}

		for _, ext := range filter {
			cleanExt := strings.TrimPrefix(ext, ".")
			filterExtensions = append(filterExtensions, "*."+cleanExt)
		}

		filterStr := strings.Join(filterExtensions, ";")
		displayName := "Files"

		// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∏–ª—å—Ç—Ä–∞
		if len(filter) == 1 && (strings.Contains(filter[0], "jpg") ||
			strings.Contains(filter[0], "jpeg") ||
			strings.Contains(filter[0], "png") ||
			strings.Contains(filter[0], "gif") ||
			strings.Contains(filter[0], "bmp")) {
			displayName = "Image files"
		} else if len(filter) == 1 && (strings.Contains(filter[0], "pdf") ||
			strings.Contains(filter[0], "doc") ||
			strings.Contains(filter[0], "txt")) {
			displayName = "Document files"
		}

		psScript += fmt.Sprintf(`$dialog.Filter = "%s (%s)|%s"`,
			displayName,
			strings.Join(filterExtensions, ", "),
			filterStr)

		// –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–í—Å–µ —Ñ–∞–π–ª—ã" –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
		psScript += `
$dialog.FilterIndex = 1
$dialog.DefaultExt = "` + filterExtensions[0] + `"`
	}

	psScript += `
$result = $dialog.ShowDialog()
if ($result -eq [System.Windows.Forms.DialogResult]::OK) {
    foreach ($file in $dialog.FileNames) {
        Write-Output $file
    }
} else {
    Write-Output ""
}
`

	// –í—ã–ø–æ–ª–Ω—è–µ–º PowerShell —Å–∫—Ä–∏–ø—Ç
	cmd := exec.Command("powershell", "-Command", psScript)
	output, err := cmd.Output()
	if err != nil {
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –±—ã—Ç—å —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞
		if exitErr, ok := err.(*exec.ExitError); ok && exitErr.ExitCode() == 0 {
			return []string{}, nil
		}
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞: %v", err)
	}

	// –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
	outputStr := strings.TrimSpace(string(output))
	if outputStr == "" {
		return []string{}, nil
	}

	// –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ (PowerShell –≤—ã–≤–æ–¥–∏—Ç –∫–∞–∂–¥–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
	lines := strings.ReplaceAll(outputStr, "\r\n", "\n")
	files := strings.Split(lines, "\n")

	// –û—á–∏—â–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
	var cleanFiles []string
	for _, file := range files {
		cleanFile := strings.TrimSpace(file)
		if cleanFile != "" && cleanFile != "\"" {
			cleanFiles = append(cleanFiles, cleanFile)
		}
	}

	return cleanFiles, nil
}

// CreateFileUploadArea —Å–æ–∑–¥–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
func CreateFileUploadArea(config FileUploadConfig, state *FileUploadState, parentWindow fyne.Window) *fyne.Container {
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SelectedFiles –µ—Å–ª–∏ nil
	if state.SelectedFiles == nil {
		emptySlice := []string{}
		state.SelectedFiles = &emptySlice
	}

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UpdateDisplay –µ—Å–ª–∏ nil (–í–ê–ñ–ù–û!)
	if state.UpdateDisplay == nil {
		state.UpdateDisplay = func() {}
	}

	// –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å —Ñ–æ–Ω–æ–º
	box := canvas.NewRectangle(config.BackgroundColor)
	box.CornerRadius = 8
	box.SetMinSize(config.MinSize)

	// –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
	filesContainer := container.NewVBox()

	// –ú–µ—Ç–∫–∞
	label := widget.NewLabel(config.Label)
	label.Alignment = fyne.TextAlignCenter

	// –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ box
	contentContainer := container.NewVBox(filesContainer, container.NewCenter(label))

	containerWithContent := container.NewStack(box, contentContainer)

	// –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∫–ª–∏–∫–∞ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º)
	clickButton := widget.NewButton("", func() {
		// –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥ Windows
		selectedFiles, err := openWindowsFileDialog(config.Filter, true)
		if err != nil {
			// –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
			errorLabel := widget.NewLabel(fmt.Sprintf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–æ–≤:\n%v", err))
			errorLabel.Wrapping = fyne.TextWrapWord

			closeButton := widget.NewButton("–ó–∞–∫—Ä—ã—Ç—å", nil)

			popupContent := container.NewVBox(
				errorLabel,
				container.NewCenter(closeButton),
			)

			dialog := widget.NewModalPopUp(popupContent, parentWindow.Canvas())

			closeButton.OnTapped = func() {
				dialog.Hide()
			}

			dialog.Show()
			return
		}

		if len(selectedFiles) > 0 {
			// –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Å–ø–∏—Å–æ–∫
			*state.SelectedFiles = append(*state.SelectedFiles, selectedFiles...)
			state.UpdateDisplay()
		}
	})
	clickButton.Importance = widget.LowImportance

	containerWithClick := container.NewStack(clickButton, containerWithContent)

	// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
	state.UpdateDisplay = func() {
		filesContainer.Objects = []fyne.CanvasObject{}

		// –†–∞–∑—ã–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å
		selectedFiles := *state.SelectedFiles

		// –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
		for i, filepath := range selectedFiles {
			// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏
			filename := filepath
			if lastSlash := strings.LastIndex(filepath, "\\"); lastSlash != -1 {
				filename = filepath[lastSlash+1:]
			} else if lastSlash := strings.LastIndex(filepath, "/"); lastSlash != -1 {
				filename = filepath[lastSlash+1:]
			}

			// –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –∏–º–µ–Ω–µ–º –∏ –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
			fileLabel := widget.NewLabel(filename)

			removeButton := widget.NewButton("‚ùå", func(index int) func() {
				return func() {
					// –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ —Å–ø–∏—Å–∫–∞
					currentFiles := *state.SelectedFiles
					newSelectedFiles := make([]string, 0, len(currentFiles)-1)
					for j, name := range currentFiles {
						if j != index {
							newSelectedFiles = append(newSelectedFiles, name)
						}
					}
					*state.SelectedFiles = newSelectedFiles
					state.UpdateDisplay()
				}
			}(i))
			removeButton.Importance = widget.LowImportance

			hBox := container.NewHBox(fileLabel, container.NewPadded(removeButton))

			// –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
			filesContainer.Add(hBox)
			if i < len(selectedFiles)-1 {
				filesContainer.Add(widget.NewSeparator())
			}
		}

		// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
		contentContainer.Objects = []fyne.CanvasObject{filesContainer, container.NewCenter(label)}
		contentContainer.Refresh()
	}

	// –í—ã–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
	state.UpdateDisplay()

	return containerWithClick
}


//internal\ui\modals\create_item\modal.go
package create_item

import (
	"fmt"
	"projectT/internal/storage/database/queries"

	"fyne.io/fyne/v2"
	"fyne.io/fyne/v2/container"
	"fyne.io/fyne/v2/dialog"
)

var createItemModalWindow fyne.Window

// ShowCreateItemModal –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
func ShowCreateItemModal(parentWindow fyne.Window) {
	ShowCreateItemModalWithItem(parentWindow, 0, 0) // 0 –æ–∑–Ω–∞—á–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ—Ä–Ω–µ
}

// ShowCreateItemModalForEdit –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
func ShowCreateItemModalForEdit(parentWindow fyne.Window, itemID int) {
	ShowCreateItemModalWithItem(parentWindow, itemID, 0) // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID
}

// ShowCreateItemModalWithParent –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–ø–∫–∏
func ShowCreateItemModalWithParent(parentWindow fyne.Window, parentID int) {
	ShowCreateItemModalWithItem(parentWindow, 0, parentID) // 0 –æ–∑–Ω–∞—á–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
}

// ShowCreateItemModalWithItem –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
func ShowCreateItemModalWithItem(parentWindow fyne.Window, itemID int, parentID int) {
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ —É–∂–µ –æ–∫–Ω–æ
	if createItemModalWindow != nil {
		// –ï—Å–ª–∏ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ, –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ–º –µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã–º
		createItemModalWindow.RequestFocus()
		return
	}

	// –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
	windowTitle := "–°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç"
	if itemID != 0 {
		// –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
		existingItem, err := queries.GetItemByID(itemID)
		if err == nil && existingItem != nil {
			windowTitle = fmt.Sprintf("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ \"%s\"", existingItem.Title)
		} else {
			windowTitle = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞"
		}
	}

	window := fyne.CurrentApp().NewWindow(windowTitle)
	createItemModalWindow = window // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–∫–Ω–æ

	// –°–æ–∑–¥–∞–µ–º ViewModel
	var viewModel *CreateItemViewModel
	var err error

	if itemID != 0 {
		// –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
		viewModel, err = NewCreateItemViewModelForEdit(itemID)
		if err != nil {
			dialog.ShowError(fmt.Errorf("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: %v", err), parentWindow)
			return
		}
	} else {
		// –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é ViewModel
		viewModel = NewCreateItemViewModel()
		if parentID != 0 {
			viewModel.ParentID = &parentID // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –∫–æ—Ä–Ω–µ–≤–∞—è
		}
	}

	rightColumn, formWidgets := CreateRightColumn(viewModel)
	leftColumn := CreateLeftColumn(window, viewModel, formWidgets)

	// –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–≤—É–º—è –∫–æ–ª–æ–Ω–∫–∞–º–∏
	mainContainer := container.NewHSplit(leftColumn, rightColumn)
	mainContainer.Offset = 0.3 // –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 30% —à–∏—Ä–∏–Ω—ã

	// –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
	modalContent := container.NewVBox(mainContainer)

	// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏ —Ä–∞–∑–º–µ—Ä—ã
	window.SetContent(modalContent)
	window.Resize(fyne.NewSize(750, 300))

	// –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
	window.SetOnClosed(func() {
		createItemModalWindow = nil
	})

	window.Show()
}


//internal\storage\filesystem\manager.go
package filesystem

import (
	"fmt"
	"io"
	"mime"
	"net/http"
	"os"
	"path/filepath"
)

// FileData —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
type FileData struct {
	Hash     string
	Size     int64
	MimeType string
	Path     string
}

// SaveFile —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫ –ø–æ —Ö—ç—à-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
// –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ö—ç—à, —Ä–∞–∑–º–µ—Ä –∏ MIME-—Ç–∏–ø
func SaveFile(fileBytes []byte) (*FileData, error) {
	// –í—ã—á–∏—Å–ª—è–µ–º —Ö—ç—à —Ñ–∞–π–ª–∞
	hash := CalculateHash(fileBytes)

	// –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
	filePath := GetFilePath(hash)

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º —Ö—ç—à–µ–º
	if _, err := os.Stat(filePath); err == nil {
		// –§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–º
		info, err := os.Stat(filePath)
		if err != nil {
			return nil, err
		}

		// –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
		mimeType := mime.TypeByExtension(filepath.Ext(filePath))
		if mimeType == "" {
			mimeType = detectMimeType(fileBytes)
		}

		return &FileData{
			Hash:     hash,
			Size:     info.Size(),
			MimeType: mimeType,
			Path:     filePath,
		}, nil
	}

	// –°–æ–∑–¥–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
	if err := EnsureParentDir(filePath); err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: %w", err)
	}

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
	if err := os.WriteFile(filePath, fileBytes, 0644); err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}

	// –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø
	mimeType := detectMimeType(fileBytes)

	// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
	info, err := os.Stat(filePath)
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ: %w", err)
	}

	return &FileData{
		Hash:     hash,
		Size:     info.Size(),
		MimeType: mimeType,
		Path:     filePath,
	}, nil
}

// ReadFile —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª –ø–æ –µ–≥–æ —Ö—ç—à—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
func ReadFile(hash string) ([]byte, error) {
	filePath := GetFilePath(hash)

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
	if _, err := os.Stat(filePath); os.IsNotExist(err) {
		return nil, fmt.Errorf("—Ñ–∞–π–ª —Å —Ö—ç—à–µ–º %s –Ω–µ –Ω–∞–π–¥–µ–Ω", hash)
	}

	// –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
	fileBytes, err := os.ReadFile(filePath)
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}

	return fileBytes, nil
}

// DeleteFile —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª —Å –¥–∏—Å–∫–∞
func DeleteFile(hash string) error {
	filePath := GetFilePath(hash)

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
	if _, err := os.Stat(filePath); os.IsNotExist(err) {
		return fmt.Errorf("—Ñ–∞–π–ª —Å —Ö—ç—à–µ–º %s –Ω–µ –Ω–∞–π–¥–µ–Ω", hash)
	}

	// –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª
	if err := os.Remove(filePath); err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}

	return nil
}

// GetFileInfo –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –ø–æ –µ–≥–æ —Ö—ç—à—É
func GetFileInfo(hash string) (*FileData, error) {
	filePath := GetFilePath(hash)

	// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
	info, err := os.Stat(filePath)
	if err != nil {
		if os.IsNotExist(err) {
			return nil, fmt.Errorf("—Ñ–∞–π–ª —Å —Ö—ç—à–µ–º %s –Ω–µ –Ω–∞–π–¥–µ–Ω", hash)
		}
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ: %w", err)
	}

	// –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã —Ñ–∞–π–ª–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è MIME-—Ç–∏–ø–∞
	file, err := os.Open(filePath)
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}
	defer file.Close()

	buffer := make([]byte, 512)
	_, err = file.Read(buffer)
	if err != nil && err != io.EOF {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}

	mimeType := detectMimeType(buffer)

	return &FileData{
		Hash:     hash,
		Size:     info.Size(),
		MimeType: mimeType,
		Path:     filePath,
	}, nil
}

// detectMimeType –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç MIME-—Ç–∏–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
func detectMimeType(fileBytes []byte) string {
	mimeType := http.DetectContentType(fileBytes)
	return mimeType
}

// Exists –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Ö—ç—à–µ–º
func Exists(hash string) bool {
	filePath := GetFilePath(hash)
	_, err := os.Stat(filePath)
	return !os.IsNotExist(err)
}


//internal\ui\modals\create_item\left_column.go
package create_item

import (
	"encoding/json"
	"fmt"
	"image/color"
	"projectT/internal/storage/database/models"
	"projectT/internal/storage/database/queries"
	"strings"

	"fyne.io/fyne/v2"
	"fyne.io/fyne/v2/container"
	"fyne.io/fyne/v2/dialog"
	"fyne.io/fyne/v2/widget"
)

// CreateLeftColumn —Å–æ–∑–¥–∞–µ—Ç –ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∑–∞–≥—Ä—É–∑–∫–∏
func CreateLeftColumn(modalWindow fyne.Window, viewModel *CreateItemViewModel, formWidgets *FormWidgets) *fyne.Container {
	// –°–æ–∑–¥–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Ñ–∞–π–ª–æ–≤
	imageState := &FileUploadState{
		SelectedFiles: &viewModel.Images,
		UpdateDisplay: func() {},
	}

	fileState := &FileUploadState{
		SelectedFiles: &viewModel.Files,
		UpdateDisplay: func() {},
	}

	// –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
	imageConfig := FileUploadConfig{
		Label:           "üñºÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–æ–±–ª–æ–∂–∫—É",
		Filter:          []string{".png", ".jpg", ".jpeg", ".gif", ".bmp"},
		BackgroundColor: color.RGBA{R: 30, G: 30, B: 30, A: 25},
		MinSize:         fyne.NewSize(150, 100),
		UploadType:      ImageUpload,
	}

	imageUploadArea := CreateFileUploadArea(imageConfig, imageState, modalWindow)

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –≤–∏–¥–∂–µ—Ç–∞—Ö —Ñ–æ—Ä–º—ã
	formWidgets.ImageUploadArea = imageUploadArea

	// –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
	fileConfig := FileUploadConfig{
		Label:           "üìé –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª",
		Filter:          nil,
		BackgroundColor: color.RGBA{R: 30, G: 30, B: 30, A: 25},
		MinSize:         fyne.NewSize(150, 60),
		UploadType:      FileUpload,
	}

	fileUploadArea := CreateFileUploadArea(fileConfig, fileState, modalWindow)

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –≤–∏–¥–∂–µ—Ç–∞—Ö —Ñ–æ—Ä–º—ã
	formWidgets.FileUploadArea = fileUploadArea

	// –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å" –∏–ª–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
	buttonText := "–°–æ–∑–¥–∞—Ç—å"
	if viewModel.EditMode {
		buttonText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
	}

	createButton := widget.NewButton(buttonText, func() {
		// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º ViewModel
		updateViewModelFromUI(viewModel, formWidgets, *imageState.SelectedFiles, *fileState.SelectedFiles)

		// –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ ViewModel
		createItemFromViewModel(viewModel, modalWindow)
	})

	// –ö–æ–º–ø–æ–Ω–æ–≤–∫–∞ –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
	leftContent := container.NewVBox(
		formWidgets.ImageUploadArea,
		widget.NewSeparator(),
		formWidgets.FileUploadArea,
		widget.NewSeparator(),
		container.NewPadded(container.NewCenter(createButton)),
	)

	return leftContent
}

// updateViewModelFromUI –æ–±–Ω–æ–≤–ª—è–µ—Ç ViewModel —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ UI
func updateViewModelFromUI(viewModel *CreateItemViewModel, formWidgets *FormWidgets, selectedImages, selectedFiles []string) {
	// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
	if formWidgets.Tabs.CurrentTab().Text == "–≠–ª–µ–º–µ–Ω—Ç" {
		viewModel.Title = formWidgets.TitleEntry.Text
		viewModel.Description = formWidgets.DescriptionEntry.Text
		viewModel.Tags = formWidgets.TagsEntry.Text
		viewModel.ItemType = models.ItemTypeText
	} else if formWidgets.Tabs.CurrentTab().Text == "–ü–∞–ø–∫–∞" {
		viewModel.Title = formWidgets.TitleEntry.Text
		viewModel.Description = formWidgets.DescriptionEntry.Text
		viewModel.Tags = formWidgets.TagsEntry.Text
		viewModel.ItemType = models.ItemTypeFolder
	}

	viewModel.Images = selectedImages
	viewModel.Files = selectedFiles

	// –°–æ–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
	var links []string
	for _, entry := range formWidgets.LinkEntries {
		if entry.Text != "" {
			links = append(links, entry.Text)
		}
	}
	viewModel.Links = links
}

// createItemFromViewModel —Å–æ–∑–¥–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –∏–∑ ViewModel
func createItemFromViewModel(viewModel *CreateItemViewModel, modalWindow fyne.Window) {
	// –ü–æ–¥–≥–æ–ª–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
	fmt.Printf("=== –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ===\n")
	fmt.Printf("Title: %s\n", viewModel.Title)
	fmt.Printf("Description: %s\n", viewModel.Description)
	fmt.Printf("Tags: %s\n", viewModel.Tags)
	fmt.Printf("ItemType: %s (—Ç–∏–ø: %T)\n", viewModel.ItemType, viewModel.ItemType)
	fmt.Printf("Images: %v\n", viewModel.Images)
	fmt.Printf("Files: %v\n", viewModel.Files)
	fmt.Printf("Links: %v\n", viewModel.Links)
	fmt.Printf("===========================\n")

	// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
	itemType := viewModel.ItemType

	// –ï—Å–ª–∏ —Ç–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏), –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
	if itemType == "" || itemType == models.ItemTypeText {
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
		hasDescription := viewModel.Description != ""
		hasImages := len(viewModel.Images) > 0
		hasFiles := len(viewModel.Files) > 0
		hasLinks := len(viewModel.Links) > 0 && viewModel.Links[0] != ""

		// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
		switch {
		case hasLinks && (hasImages || hasFiles):
			// –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ —Å —Ñ–∞–π–ª–æ–º/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
			itemType = models.ItemTypeComposite
		case hasFiles && (hasImages || hasLinks):
			// –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º/—Å—Å—ã–ª–∫–æ–π - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
			itemType = models.ItemTypeComposite
		case hasImages && (hasLinks || hasFiles):
			// –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —á–µ–º-—Ç–æ –µ—â–µ - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
			itemType = models.ItemTypeComposite
		case hasLinks:
			// –¢–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∞ (–∏–ª–∏ —Å—Å—ã–ª–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º)
			itemType = models.ItemTypeLink
		case hasFiles:
			// –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã (–∏–ª–∏ —Ñ–∞–π–ª—ã —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º)
			itemType = models.ItemTypeFile
		case hasImages:
			// –¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º)
			itemType = models.ItemTypeImage
		case hasDescription && !hasImages && !hasFiles && !hasLinks:
			// –¢–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö - —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
			itemType = models.ItemTypeText
		default:
			// –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
			itemType = models.ItemTypeText
		}
	}

	type Block struct {
		Type         string `json:"type"`
		Content      string `json:"content,omitempty"`
		FileHash     string `json:"file_hash,omitempty"`
		OriginalName string `json:"original_name,omitempty"`
		Description  string `json:"description,omitempty"`
	}

	var blocks []Block

	// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
	for _, filename := range viewModel.Images {
		blocks = append(blocks, Block{
			Type:         "image",
			OriginalName: filename,
		})
	}

	// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
	for _, filename := range viewModel.Files {
		blocks = append(blocks, Block{
			Type:         "file",
			OriginalName: filename,
		})
	}

	// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏
	for _, link := range viewModel.Links {
		if link != "" {
			blocks = append(blocks, Block{
				Type:    "link",
				Content: link,
			})
		}
	}

	// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±–ª–æ–∫–∏ –≤ JSON
	contentMeta, err := json.Marshal(blocks)
	if err != nil {
		dialog.ShowError(err, modalWindow)
		return
	}

	// –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
	var item *models.Item

	if viewModel.EditMode && viewModel.ID != 0 {
		// –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
		existingItem, err := queries.GetItemByID(viewModel.ID)
		if err != nil {
			dialog.ShowError(fmt.Errorf("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: %v", err), modalWindow)
			return
		}

		// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
		existingItem.Type = itemType
		existingItem.Title = viewModel.Title
		existingItem.Description = viewModel.Description
		existingItem.ContentMeta = string(contentMeta)
		existingItem.ParentID = viewModel.ParentID

		// –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
		if err := queries.UpdateItem(existingItem); err != nil {
			dialog.ShowError(fmt.Errorf("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞: %v", err), modalWindow)
			return
		}

		item = existingItem
		fmt.Printf("–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å ID: %d\n", item.ID)
	} else {
		// –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
		item = &models.Item{
			Type:        itemType,
			Title:       viewModel.Title,
			Description: viewModel.Description,
			ContentMeta: string(contentMeta),
			ParentID:    viewModel.ParentID, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É
		}

		// –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
		if err := queries.CreateItem(item); err != nil {
			dialog.ShowError(err, modalWindow)
			return
		}

		fmt.Printf("–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å ID: %d\n", item.ID)
	}

	fmt.Printf("–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å ID: %d\n", item.ID)

	// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–≥–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
	if viewModel.Tags != "" {
		fmt.Printf("–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤: %s\n", viewModel.Tags)
		// –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–≥–∏ –ø–æ –∑–∞–ø—è—Ç–æ–π
		tags := strings.Split(viewModel.Tags, ",")
		for _, tagStr := range tags {
			tagStr = strings.TrimSpace(tagStr)
			if tagStr != "" {
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–≥ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
				existingTag, err := queries.GetTagByName(tagStr)
				if err != nil {
					// –ï—Å–ª–∏ —Ç–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
					fmt.Printf("–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞: %s\n", tagStr)
					newTag := &models.Tag{Name: tagStr}
					if err := queries.CreateTag(newTag); err != nil {
						dialog.ShowError(fmt.Errorf("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞ '%s': %v", tagStr, err), modalWindow)
						continue // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–µ–≥–æ–≤
					}
					existingTag = newTag
					fmt.Printf("–¢–µ–≥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —Å ID: %d\n", newTag.ID)
				} else {
					fmt.Printf("–¢–µ–≥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: %s (ID: %d)\n", existingTag.Name, existingTag.ID)
				}

				// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ç–µ–≥ –∫ —ç–ª–µ–º–µ–Ω—Ç—É
				if err := queries.AddTagToItem(item.ID, existingTag.ID); err != nil {
					dialog.ShowError(fmt.Errorf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ —Ç–µ–≥–∞ '%s' –∫ —ç–ª–µ–º–µ–Ω—Ç—É: %v", tagStr, err), modalWindow)
				} else {
					fmt.Printf("–¢–µ–≥ '%s' —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç–ª–µ–º–µ–Ω—Ç—É\n", tagStr)
				}
			}
		}
		fmt.Printf("–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n")
	} else {
		fmt.Println("–¢–µ–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã")
	}

	// –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
	modalWindow.Close()
}

//internal\storage\filesystem\storage.go
package filesystem

import (
	"os"
	"path/filepath"
)

const (
	// StorageDir –æ—Å–Ω–æ–≤–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
	StorageDir = "./internal/storage"
	// FilesDir –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ñ–∞–π–ª–æ–≤
	FilesDir = "files"
)

// EnsureStorageStructure –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
func EnsureStorageStructure() error {
	// –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
	if err := os.MkdirAll(StorageDir, 0755); err != nil {
		return err
	}

	// –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∞–π–ª–æ–≤
	filesPath := filepath.Join(StorageDir, FilesDir)
	if err := os.MkdirAll(filesPath, 0755); err != nil {
		return err
	}

	return nil
}

// GetFilePath –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ø–æ –µ–≥–æ —Ö—ç—à—É
func GetFilePath(hash string) string {
	if len(hash) < 2 {
		// –ï—Å–ª–∏ —Ö—ç—à —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ñ–∞–π–ª–æ–≤
		return filepath.Join(StorageDir, FilesDir, hash)
	}

	// –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å: storage/files/{–ø–µ—Ä–≤—ã–µ_2_—Å–∏–º–≤–æ–ª–∞_—Ö—ç—à–∞}/{–ø–æ–ª–Ω—ã–π_—Ö—ç—à}
	prefix := hash[:2]
	return filepath.Join(StorageDir, FilesDir, prefix, hash)
}

// EnsureParentDir —Å–æ–∑–¥–∞–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
func EnsureParentDir(filePath string) error {
	parentDir := filepath.Dir(filePath)
	return os.MkdirAll(parentDir, 0755)
}
